//=========================================================
// src/Interrupts.c: generated by Hardware Configurator
//
// This file will be regenerated when saving a document.
// leave the sections inside the "$[...]" comment tags alone
// or they will be overwritten!
//=========================================================

// USER INCLUDES			
#include <SI_EFM8UB1_Register_Enums.h>
#include "Flags.h"
//-----------------------------------------------------------------------------
// Global CONSTANTS
//-----------------------------------------------------------------------------
#define UART_BUFFERSIZE        64

//-----------------------------------------------------------------------------
// Global Variables
//-----------------------------------------------------------------------------
SI_SEGMENT_VARIABLE(UART_Buffer[UART_BUFFERSIZE], uint8_t, SI_SEG_IDATA);
uint8_t UART_Buffer_Size = 0;
uint8_t UART_Input_First = 0;
uint8_t UART_Output_First = 0;
uint8_t TX_Ready = 1;
uint8_t Byte = 0x00;
uint8_t increase = 0;
uint8_t decrease = 0;
SI_SBIT (S1, SFR_P0, 2);
SI_SBIT (S2, SFR_P0, 3);
uint8_t wish_to_send = 0;
uint8_t received_data=0;
extern uint8_t temp_SFR_page;

//-----------------------------------------------------------------------------
// UART1_ISR
//-----------------------------------------------------------------------------
//
// UART1 ISR Content goes here. Remember to clear flag bits:
// SCON1::RI (Receive Interrupt Flag)
// SCON1::TI (Transmit Interrupt Flag)
// UART1FCN1::RFRQ (Receive FIFO Request)
// UART1FCN1::TFRQ (Transmit FIFO Request)
//
//-----------------------------------------------------------------------------
SI_INTERRUPT(UART1_ISR, UART1_IRQn)
{
	if (SCON1_RI == 1)
	{


		SCON1_RI = 0;// Clear interrupt flag
		/*
		 * The 485 transceiver on the EXP always reads data, even the data that the MCU STK sends
		 * If it reads data that is the same as the data we just sent(Byte) ignore it.
		 * */
		if(SBUF1 != Byte)
		{
			Byte = SBUF1;
			received_data=1;
		}
		// Read a character from UART
		UART_Buffer_Size=1;

	}

	if (SCON1_TI == 1)// Check if transmit flag is set
	{
		SCON1_TI = 0;                      // Clear interrupt flag
		decrease = 0;
		increase = 0;
		if(wish_to_send == 1)
		{
			temp_SFR_page = SFRPAGE;
			SFRPAGE = UART1_PAGE;
			wish_to_send=0;
			SBUF1 = Byte;		// Transmit to Hyperterminal


			SFRPAGE = temp_SFR_page;
		}
		else
		{
			TX_Ready = 1;
		}


	}
}

SI_INTERRUPT(PMATCH_ISR, PMATCH_IRQn)
{
	wish_to_send = 1;
	// If the Port Match event occurred on S1
	if(S1 == 0)
	{
		increase = 1;
		decrease = 0;
	}
	// If the Port Match event occurred on S2
	if(S2 == 0)
	{
		decrease = 1;
		increase = 0;
	}
	EIE1 &= ~0x02;
	/*
	* Disable Port Match interrupts to
	* prevent multiple interrupts from
	* occurring while the switches are pressed
	*/
}

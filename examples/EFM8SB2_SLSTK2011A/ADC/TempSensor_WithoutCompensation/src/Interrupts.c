//=========================================================
// src/Interrupts.c: generated by Hardware Configurator
//
// This file will be regenerated when saving a document.
// leave the sections inside the "$[...]" comment tags alone
// or they will be overwritten!
//=========================================================


// USER INCLUDES
#include <SI_EFM8SB2_Register_Enums.h>

//-----------------------------------------------------------------------------
// Global Constants
//-----------------------------------------------------------------------------
#define SAMPLING_NUMBER            256 // Number of samples per calculation

//-----------------------------------------------------------------------------
// Global VARIABLES
//-----------------------------------------------------------------------------
extern uint32_t ADC_SUM;               // Accumulates the ADC samples
extern bool CONV_COMPLETE;              // ADC accumulated result ready flag

//-----------------------------------------------------------------------------
// ADC0EOC_ISR
//-----------------------------------------------------------------------------
//
// ADC0EOC ISR Content goes here. Remember to clear flag bits:
// ADC0CN0::ADINT (Conversion Complete Interrupt Flag)
//
//-----------------------------------------------------------------------------
SI_INTERRUPT(ADC0EOC_ISR, ADC0EOC_IRQn)
{
   static unsigned long accumulator = 0; // accumulator for averaging
   static unsigned int measurements = SAMPLING_NUMBER; // measurement counter

   ADC0CN0_ADINT = 0;                  // clear ADC0 conv. complete flag

   // Checks if obtained the necessary number of samples
   if(measurements == 0)
   {

	  ADC_SUM = accumulator;           // Copy total into ADC_SUM
	  measurements = 256;              // Reset counter
	  accumulator = 0;                 // Reset accumulator
	  CONV_COMPLETE = 1;               // Set result ready flag
   }
   else
   {
	  accumulator += ADC0 >> 6;        // If not, keep adding while shifting
									   // out unused bits in ADC0
	  measurements--;
   }
}



